/*
Deployment script for HeraAI

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "HeraAI"
:setvar DefaultFilePrefix "HeraAI"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
-- GENERATES A NEW DATABASE IF DOES NOT EXISTS YET
IF NOT EXISTS(SELECT [Name] FROM [SYS].[DATABASES] WHERE [Name] = 'HeraAI')
BEGIN
	CREATE DATABASE TNet COLLATE LATIN1_GENERAL_CI_AS 
	-- RECOMENDATION: SET ALSO THIS PROPERTIES OF THIS PROJECT TO THE SAME COLLATION.
END		
GO

GO
PRINT N'Creating Table [dbo].[Users]...';


GO
CREATE TABLE [dbo].[Users] (
    [Id]           NVARCHAR (6)   NOT NULL,
    [CountryId]    NVARCHAR (6)   NULL,
    [Language]     NVARCHAR (6)   NOT NULL,
    [Email]        NVARCHAR (500) NOT NULL,
    [Password]     NVARCHAR (150) NOT NULL,
    [FirstName]    NVARCHAR (150) NOT NULL,
    [LastName]     NVARCHAR (150) NOT NULL,
    [Phone]        NVARCHAR (20)  NULL,
    [Inactive]     BIT            NOT NULL,
    [CreationDate] DATETIME       NOT NULL,
    [LastUpdate]   DATETIME       NOT NULL,
    [LastUserId]   NVARCHAR (6)   NOT NULL,
    CONSTRAINT [PK_Users] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[Users]...';


GO
ALTER TABLE [dbo].[Users]
    ADD DEFAULT 'en-US' FOR [Language];


GO
PRINT N'Creating Function [dbo].[uFN_GlobalVars]...';


GO
/*
	USAGE EXAMPLE
	SELECT [dbo].[uFN_GlobalVars]('WeighingBaseUnit');
*/

/*
-- DROP SP IF EXISTS
IF OBJECT_ID('[dbo].[uFN_GlobalVars]','FN') IS NOT NULL
   DROP FUNCTION [dbo].[uFN_GlobalVars]
GO
*/


CREATE FUNCTION [dbo].[uFN_GlobalVars]
(
	@tokenType NVARCHAR(25)
)
RETURNS NVARCHAR(40)

AS
BEGIN

	-- VARIABLES
	DECLARE @source NVARCHAR(100)				= 'HeraAI.uFN_GlobalVars';
	DECLARE @result NVARCHAR(10)				= '';
	DECLARE @error NVARCHAR(256)				= '';


	-- NULL VALIDATIONS
	IF @tokenType IS NULL 
	   SET @error = @error + 'input argument tokenType is required;';


	-- CONTENT VALIDATIONS
	IF UPPER(@tokenType) NOT IN ('ADMINUSER','BASECOUNTRY', 'BASELANGUAGE')
	   SET @error = @error + 'input argument tokenType has an unexpected content (' + @tokenType + ');'; 


	-- RETRIEVE THE NEXT TOKEN
	IF UPPER(@tokenType) = 'ADMINUSER'
	   SET @result = '000000';
	ELSE IF UPPER(@tokenType) = 'BASECOUNTRY'
	   SET @result = 'US';
	ELSE IF UPPER(@tokenType) = 'BASELANGUAGE'
	   SET @result = 'en-US';
	ELSE
		SET @error = @error + 'unexpected error'

	-- THROW ERROR IF NEEDED
	IF @error <> ''
	   SET @result = CAST(@source + ' ' + @error AS INT);


	-- END
	RETURN @result;


END
GO
-- DEFAULT USERS
IF (SELECT COUNT('-') FROM [dbo].[Users]) = 0
BEGIN

        INSERT INTO [dbo].[Users] ([Id], [CountryId], [Language], [Email], [Password], [FirstName], [LastName], [Phone], [Inactive], [CreationDate], [LastUpdate], [LastUserId])
        VALUES ('000000', NULL, [dbo].[uFN_GlobalVars]('BASELANGUAGE'), 'teste@email.pt', 'tZiiwVQPc0IUsja1v2Xx+g==', 'Hera', 'AI', '963333333', CAST('false' AS BIT), GETDATE(), GETDATE(), [dbo].[uFN_GlobalVars]('ADMINUSER'));

END
GO

GO
PRINT N'Update complete.';


GO
